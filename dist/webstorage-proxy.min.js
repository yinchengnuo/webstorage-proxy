!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).WebStorageProxy=t()}(this,function(){"use strict";function r(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(t){g(t)._DELETENOMAPTOSTORAGE=!0,Object.keys(t.state).forEach(function(e){return delete t.state[e]}),g(t)._DELETENOMAPTOSTORAGE=!1}var s=function(){return{length:0}},E=function(e){return{0:e,length:1}},a=function(e,t){for(var o=arguments.length,r=new Array(2<o?o-2:0),n=2;n<o;n++)r[n-2]=arguments[n];for(var i=0;i<e.length;i++){var s;(s=e[i]).call.apply(s,[t].concat(r))}},c=function(e){return"beforeGet"===e||"geted"===e||"beforeSet"===e||"proxySeted"===e||"storageSeted"===e||"storageChanged"===e||"_NAMESPACE"===e||"_DELETENOMAPTOSTORAGE"===e},l=function(e){return new Proxy(e,{set:function(e,t,o){if(t==e.length&&"function"==typeof o)return Reflect.set(e,t,o),e.length=e.length+=1,!0},deleteProperty:function(){return!1}})},h=function(e){e.beforeCreate=function(){},e.created=function(){},e.beforeGet=l(s()),e.geted=l(s()),e.beforeSet=l(s()),e.proxySeted=l(s()),e.storageSeted=l(s()),e.beforeDel=l(s()),e.proxyDeled=l(s()),e.storageDeled=l(s()),e.storageChanged=l(s()),e.beforeDestroy=function(){},e.destroyed=function(){}},f=function(e,t,o,r,n){window.dispatchEvent(new StorageEvent(e,{key:o,newValue:r,oldValue:n,storageArea:t,url:window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]}))},S=function(e,t,o,r,n,i){for(var s=e.storageChanged.length,E=0;E<s;E++)e.storageChanged[E].call(e,new StorageEvent(t,{key:r,newValue:n,oldValue:i,storageArea:o,url:window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]}))},u=function(e,t){if("string"==typeof t)e._NAMESPACE=t;else if("function"==typeof t){for(var o=[],r=new RegExp("".concat(e._WEBSTORAGEPROXY_NAMESPACE,":")),n=0;n<window[e._TYPE].length;n++)window[e._TYPE].key(n).match(r)&&o.push(window[e._TYPE].key(n).replace(r,""));e._NAMESPACE="string"==typeof t(o)?t(o):null,r=o=null}else e._NAMESPACE=null},T=function(e){return"string"==typeof e},_=function(e){return"[object Function]"===Object.prototype.toString.call(e)},y=function(e){return"[object Object]"===Object.prototype.toString.call(e)},p=function(e){return"[object Array]"===Object.prototype.toString.call(e)},O=function(e,t){return t.split(":")[0]===e._WEBSTORAGEPROXY_NAMESPACE||t.split(":")[0]===e._WEBSTORAGEPROXY_INDENT_STORAGE},g=function(e){return Object.getPrototypeOf(e)};function A(){if(this._NAMESPACE){var e=window[this._TYPE][this._GETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE));e?(_(this.encryption)&&_(this.decryption)?Object.assign(this.state,JSON.parse(this.decryption(e))):Object.assign(this.state,JSON.parse(e)),e=null):window[this._TYPE][this._SETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE),"")}else{for(var t=window[this._TYPE],o=new RegExp("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":")),r=new RegExp("".concat(this._WEBSTORAGEPROXY_INDENT_STORAGE)),n=0;n<t.length;n++)if(!t.key(n).match(o)&&!t.key(n).match(r))try{this.state[t.key(n)]=JSON.parse(t[this._GETITEM](t.key(n)))}catch(e){this.state[t.key(n)]=t[this._GETITEM](t.key(n))}r=o=t=null}}function d(e){var t=window[this._TYPE],o=arguments.length<=2?void 0:arguments[2],r=t[this._GETITEM](o);if(this._NAMESPACE){var n="_WEBSTORAGEPROXY_INDENT_STORAGE:".concat(this._NAMESPACE);return t[this._SETITEM](n,this.encryption(JSON.stringify(this.state))),S.call(t,this,this._TYPE.toLowerCase()+"change",t,n,this.encryption(JSON.stringify(this.state)),r),!(r=o=t=null)}for(var i=Object.keys(this.state),s=0;s<i.length;s++)if(p(this.state[i[s]])||y(this.state[i[s]])){if(JSON.stringify(e[i[s]])!==JSON.stringify(this.state[i[s]]))return t[this._SETITEM](o,JSON.stringify(this.state[i[s]])),f.call(t,this._TYPE.toLowerCase()+"change",t,o,JSON.stringify(this.state[i[s]]),r),!0}else if(e[i[s]]!==this.state[i[s]])return t[this._SETITEM](o,this.state[i[s]]),f.call(t,this._TYPE.toLowerCase()+"change",t,o,JSON.stringify(this.state[i[s]]),r),!0}var n=function(){function n(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),function(e){1==e.length?T(e[0])?(this._TYPE=e[0],this._NAMESPACE=null,h(this)):y(e[0])&&(this._TYPE=e[0].type,u(this,e[0].nameSpace),this.beforeCreate=_(e[0].beforeCreate)?e[0].beforeCreate:function(){},this.created=_(e[0].created)?e[0].created:function(){},this.beforeGet=_(e[0].beforeGet)?l(E(e[0].beforeGet)):l(s()),this.geted=_(e[0].geted)?l(E(e[0].geted)):l(s()),this.beforeSet=_(e[0].beforeSet)?l(E(e[0].beforeSet)):l(s()),this.proxySeted=_(e[0].proxySeted)?l(E(e[0].proxySeted)):l(s()),this.storageSeted=_(e[0].storageSeted)?l(E(e[0].storageSeted)):l(s()),this.beforeDel=_(e[0].beforeDel)?l(E(e[0].beforeDel)):l(s()),this.proxyDeled=_(e[0].proxyDeled)?l(E(e[0].proxyDeled)):l(s()),this.storageDeled=_(e[0].storageDeled)?l(E(e[0].storageDeled)):l(s()),this.storageChanged=_(e[0].storageChanged)?l(E(e[0].storageChanged)):l(s()),this.beforeDestroy=_(e[0].beforeDestroy)?e[0].beforeDestroy:function(){},this.destroyed=_(e[0].destroyed)?e[0].destroyed:function(){}):(this._TYPE=e[0],u(this,e[2]),h(this))}.call(r=this,t),r.beforeCreate.call(window),r.state=Object.create(r),A.call(r),function(){var s=this,e=function n(i){return Object.keys(i).forEach(function(e){(p(i[e])||y(i[e]))&&(i[e]=n(i[e]).proxy)}),Proxy.revocable(i,{get:function(e,t){return c(t&&g(i)===s)?s[t]:(a(s.beforeGet,e,t),Promise.resolve().then(function(){a(s.geted,e,t)}),e[t])},set:function(e,t,o){if(_(o)&&c(t)&&g(i)===s)return s[t][s[t].length]=o,!0;if(c(t))return Reflect.set(e,t,o),!0;if(e[t]===o)return!1;a(s.beforeSet,e,t,o);var r=JSON.parse(JSON.stringify(s.state));return p(o)||y(o)?e[t]=n(o):e[t]=o,a(s.proxySeted,e,t,o),d.call(s,r,e,t,o),a(s.storageSeted,e,t,o),!0},deleteProperty:function(e,t){if(t in e&&!s._DELETENOMAPTOSTORAGE){if(O(t))return!1;var o=JSON.parse(JSON.stringify(s.state));return a(s.beforeDel,e,t),Reflect.deleteProperty(e,t),a(s.proxyDeled,e,e,t),d.call(s,o,e,t),a(s.storageDeled,e,t),!0}return!!s._DELETENOMAPTOSTORAGE&&(Reflect.deleteProperty(e,t),!0)}})}(this.state);this.state=e.proxy,this.revoke=e.revoke}.call(r),Promise.resolve().then(function(){r.created()}),"localStorage"===r._TYPE&&function(o){window.addEventListener("storage",function(e){if(o._NAMESPACE){var t=new RegExp("".concat(o._WEBSTORAGEPROXY_NAMESPACE,":"));e.key.match(t)&&e.key.split(":")[1]===o._NAMESPACE&&_(o.decryption)&&Object.assign(o.state,JSON.parse(o.decryption(e.newValue)))}else O(e.key)||(o.state[e.key]=e.newValue)})}(r),r.state;var r}return function(e,t,o){t&&r(e.prototype,t),o&&r(e,o)}(n,[{key:"all",value:function(){return JSON.parse(JSON.stringify(this.state))}},{key:"use",value:function(e){if(e&&e!==this._NAMESPACE)return g(this)._NAMESPACE=e,i(this),A.call(this),!0}},{key:"del",value:function(e){return this._NAMESPACEe&&this._NAMESPACE===e&&this.use(),window[this._TYPE][g(this)._REMOVEITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(e)),!0}},{key:"has",value:function(e){return e in this.state}},{key:"clear",value:function(){var t=this;if(this._NAMESPACE)return window[this._TYPE][g(this)._SETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE),""),!0;function o(e){for(;e<window[t._TYPE].length;)O(g(t),window[t._TYPE].key(e))?e++:window[t._TYPE].removeItem(window[t._TYPE].key(e));return o}return o(0)(0),i(this),!0}},{key:"namespace",value:function(){return this._NAMESPACE}},{key:"namespaces",value:function(){for(var e=[],t=window[this._TYPE].length,o=0;o<t;o++)window[this._TYPE].key(o).split(":")[0]===g(this)._WEBSTORAGEPROXY_NAMESPACE&&e.push(window[this._TYPE].key(o).split(":")[1]);return e}},{key:"destroy",value:function(e,t){if(this.beforeDestroy.call(this),e&&this.clear(),t){var o=Storage.prototype;o.clear=o[this._CLEAR],delete o[this._CLEAR],o.setItem=o[this._SETITEM],delete o[this._SETITEM],o.getItem=o[this._GETITEM],delete o[this._GETITEM],o.removeItem=o[this._REMOVEITEM],delete o[this._REMOVEITEM]}window._WebStorageProxyDestoryedFun=this.destroyed,this.revoke(),Promise.resolve().then(function(){window._WebStorageProxyDestoryedFun.call(window),delete window._WebStorageProxyDestoryedFun})}}]),n}();return n.prototype._CLEAR=Symbol("clear"),n.prototype._GETITEM=Symbol("getItem"),n.prototype._SETITEM=Symbol("setItem"),n.prototype._REMOVEITEM=Symbol("removeItem"),n.prototype._WEBSTORAGEPROXY_NAMESPACE="_WEBSTORAGEPROXY_NAMESPACE",n.prototype._WEBSTORAGEPROXY_INDENT_STORAGE="_WEBSTORAGEPROXY_INDENT_STORAGE",n.prototype._WEBSTORAGEPROXY_INDENT_LOCALSTORAGE="_WEBSTORAGEPROXY_INDENT_LOCALSTORAGE",n.prototype._WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE="_WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE",n.prototype=new Proxy(n.prototype,{deleteProperty:function(){return!1}}),new Proxy(n,{get:function(r,e){return"crypto"===e?!r.prototype.encryption&&!Storage.prototype[n.prototype._GETITEM]&&function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];2==t.length&&_(t[0])&&_(t[1])&&(t.forEach(function(e,t){r.prototype[t?"decryption":"encryption"]=new Proxy(e,{apply:function(e,t,o){return g(t)===n.prototype&&Reflect.apply(e,t,o)}})}),Object.freeze(r.prototype))}:Reflect.get(r,e)},construct:function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];return t[1].length?(Storage.prototype[n.prototype._GETITEM]||function(r){localStorage.setItem(r._WEBSTORAGEPROXY_INDENT_STORAGE,r._WEBSTORAGEPROXY_INDENT_LOCALSTORAGE),sessionStorage.setItem(r._WEBSTORAGEPROXY_INDENT_STORAGE,r._WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE),Storage.prototype[r._CLEAR]=Storage.prototype.clear,Storage.prototype[r._GETITEM]=Storage.prototype.getItem,Storage.prototype[r._SETITEM]=Storage.prototype.setItem,Storage.prototype[r._REMOVEITEM]=Storage.prototype.removeItem,Storage.prototype.clear=function(){var o=this;!function e(t){for(;t<o.length;)O(r,o.key(t))?t++:o[r._REMOVEITEM](o.key(t));return e}(0)(0)},Storage.prototype.getItem=function(e){return!O(r,e)&&this[r._GETITEM](e)},Storage.prototype.setItem=function(e,t){if(!O(r,e)){var o=this[r._GETITEM](e);if(o!==t)return this[r._SETITEM](e,t),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/sessionStorage/i)&&f.call(this,"sessionstoragechange",this,e,t,o),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/localStorage/i)&&f.call(this,"localstoragechange",this,e,t,o),!0}return!1},Storage.prototype.removeItem=function(e){if(!O(r,e)){var t=this[r._GETITEM](e);if(null!==t)return this[r._REMOVEITEM](e),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/sessionStorage/i)&&f.call(this,"sessionstoragechange",this,e,null,t),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/localStorage/i)&&f.call(this,"localstoragechange",this,e,null,t),!0}return!1}}(n.prototype),Reflect.construct.apply(Reflect,t)):new ReferenceError("the length of arguments in WebStorageProxy can not be 0")}})}); 
