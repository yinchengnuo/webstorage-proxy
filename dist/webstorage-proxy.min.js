!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).WebStorageProxy=e()}(this,function(){"use strict";function r(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var i=function(){return{length:0}},s=function(t){return{0:t,length:1}},a=function(t,e){for(var o=arguments.length,r=new Array(2<o?o-2:0),n=2;n<o;n++)r[n-2]=arguments[n];for(var i=0;i<t.length;i++){var s;(s=t[i]).call.apply(s,[e].concat(r))}},E=function(t){return"beforeGet"===t||"geted"===t||"beforeSet"===t||"proxySeted"===t||"storageSeted"===t||"storageChanged"===t},c=function(t){return new Proxy(t,{set:function(t,e,o){if(e==t.length&&"function"==typeof o)return Reflect.set(t,e,o),t.length=t.length+=1,!0},deleteProperty:function(){return!1}})},l=function(t){t.beforeCreate=function(){},t.created=function(){},t.beforeGet=c(i()),t.geted=c(i()),t.beforeSet=c(i()),t.proxySeted=c(i()),t.storageSeted=c(i()),t.beforeDel=c(i()),t.proxyDeled=c(i()),t.storageDeled=c(i()),t.storageChanged=c(i()),t.beforeDestroy=function(){},t.destroyed=function(){}},f=function(t,e,o,r,n){window.dispatchEvent(new StorageEvent(t,{key:o,newValue:r,oldValue:n,storageArea:e,url:window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]}))},h=function(t,e,o,r,n,i){for(var s=t.storageChanged.length,a=0;a<s;a++)t.storageChanged[a].call(t,new StorageEvent(e,{key:r,newValue:n,oldValue:i,storageArea:o,url:window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]}))},S=function(t,e){if("string"==typeof e)t._NAMESPACE=e;else if("function"==typeof e){for(var o=[],r=new RegExp("".concat(t._WEBSTORAGEPROXY_NAMESPACE,":")),n=0;n<window[t._TYPE].length;n++)window[t._TYPE].key(n).match(r)&&o.push(window[t._TYPE].key(n).replace(r,""));t._NAMESPACE="string"==typeof e(o)?e(o):null,r=o=null}else t._NAMESPACE=null},p=function(t){return"string"==typeof t},u=function(t){return"[object Function]"===Object.prototype.toString.call(t)},y=function(t){return"[object Object]"===Object.prototype.toString.call(t)},T=function(t){return"[object Array]"===Object.prototype.toString.call(t)},g=function(t){return Object.getPrototypeOf(t)};function _(t){var e=window[this._TYPE],o=arguments.length<=2?void 0:arguments[2],r=e[this._GETITEM](o);if(this._NAMESPACE){var n="_WEBSTORAGEPROXY_INDENT_STORAGE:".concat(this._NAMESPACE);return e[this._SETITEM](n,this.encryption(JSON.stringify(this.state))),h.call(e,this,this._TYPE.toLowerCase()+"change",e,n,this.encryption(JSON.stringify(this.state)),r),!(r=o=e=null)}for(var i=Object.keys(this.state),s=0;s<i.length;s++)if(T(this.state[i[s]])||y(this.state[i[s]])){if(JSON.stringify(t[i[s]])!==JSON.stringify(this.state[i[s]]))return e[this._SETITEM](o,JSON.stringify(this.state[i[s]])),f.call(e,this._TYPE.toLowerCase()+"change",e,o,JSON.stringify(this.state[i[s]]),r),!0}else if(t[i[s]]!==this.state[i[s]])return e[this._SETITEM](o,this.state[i[s]]),f.call(e,this._TYPE.toLowerCase()+"change",e,o,JSON.stringify(this.state[i[s]]),r),!0}var t,n=function(){function n(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),function(t){1==t.length?p(t[0])?(this._TYPE=t[0],this._NAMESPACE=null,l(this)):y(t[0])&&(this._TYPE=t[0].type,S(this,t[0].nameSpace),this.beforeCreate=u(t[0].beforeCreate)?t[0].beforeCreate:function(){},this.created=u(t[0].created)?t[0].created:function(){},this.beforeGet=u(t[0].beforeGet)?c(s(t[0].beforeGet)):c(i()),this.geted=u(t[0].geted)?c(s(t[0].geted)):c(i()),this.beforeSet=u(t[0].beforeSet)?c(s(t[0].beforeSet)):c(i()),this.proxySeted=u(t[0].proxySeted)?c(s(t[0].proxySeted)):c(i()),this.storageSeted=u(t[0].storageSeted)?c(s(t[0].storageSeted)):c(i()),this.beforeDel=u(t[0].beforeDel)?c(s(t[0].beforeDel)):c(i()),this.proxyDeled=u(t[0].proxyDeled)?c(s(t[0].proxyDeled)):c(i()),this.storageDeled=u(t[0].storageDeled)?c(s(t[0].storageDeled)):c(i()),this.storageChanged=u(t[0].storageChanged)?c(s(t[0].storageChanged)):c(i()),this.beforeDestroy=u(t[0].beforeDestroy)?t[0].beforeDestroy:function(){},this.destroyed=u(t[0].destroyed)?t[0].destroyed:function(){}):(this._TYPE=t[0],S(this,t[2]),l(this))}.call(r=this,e),r.beforeCreate.call(window),r.state=Object.create(r),function(){if(this._NAMESPACE){var t=window[this._TYPE][this._GETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE));t?(u(this.encryption)&&u(this.decryption)?Object.assign(this.state,JSON.parse(this.decryption(t))):Object.assign(this.state,JSON.parse(t)),t=null):window[this._TYPE][this._SETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE),"")}else{for(var e=window[this._TYPE],o=new RegExp("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":")),r=new RegExp("".concat(this._WEBSTORAGEPROXY_INDENT_STORAGE)),n=0;n<e.length;n++)if(!e.key(n).match(o)&&!e.key(n).match(r))try{this.state[e.key(n)]=JSON.parse(e[this._GETITEM](e.key(n)))}catch(t){this.state[e.key(n)]=e[this._GETITEM](e.key(n))}r=o=e=null}}.call(r),function(){var s=this;this.state=function n(i){return Object.keys(i).forEach(function(t){(T(i[t])||y(i[t]))&&(i[t]=n(i[t]))}),new Proxy(i,{get:function(t,e){return E(e&&g(i)===s)?s[e]:(a(s.beforeGet,t,t,e),Promise.resolve().then(function(){a(s.geted,t,t,e)}),t[e])},set:function(t,e,o){if(u(o)&&E(e)&&g(i)===s)s[e][s[e].length]=o;else if(t[e]!==o){a(s.beforeSet,t,t,e,o);var r=JSON.parse(JSON.stringify(s.state));T(o)||y(o)?t[e]=n(o):t[e]=o,a(s.proxySeted,t,t,e,o),_.call(s,r,t,e,o),a(s.storageSeted,t,t,e,o)}},deleteProperty:function(t,e){if(e in t){if(console.log(e),"_WEBSTORAGEPROXY_INDENT_STORAGE"===e)return!1;var o=JSON.parse(JSON.stringify(s.state));return a(s.beforeDel,t,t,e),Reflect.deleteProperty(t,e),a(s.proxyDeled,t,t,e),_.call(s,o,t,e),a(s.storageDeled,t,t,e),!0}return!1}})}(this.state)}.call(r),Promise.resolve().then(function(){r.created()}),r.state;var r}return function(t,e,o){e&&r(t.prototype,e),o&&r(t,o)}(n,[{key:"all",value:function(){return function(){return JSON.parse(JSON.stringify(this.state))}.call(this)}},{key:"use",value:function(){}},{key:"del",value:function(){}},{key:"has",value:function(){}},{key:"clear",value:function(){}}]),n}();return(t=n).prototype._CLEAR=Symbol("_CLEAR"),t.prototype._GETITEM=Symbol("getItem"),t.prototype._SETITEM=Symbol("setItem"),t.prototype._REMOVEITEM=Symbol("removeItem"),t.prototype._WEBSTORAGEPROXY_NAMESPACE="_WEBSTORAGEPROXY_NAMESPACE",t.prototype._WEBSTORAGEPROXY_INDENT_STORAGE="_WEBSTORAGEPROXY_INDENT_STORAGE",t.prototype._WEBSTORAGEPROXY_INDENT_LOCALSTORAGE="_WEBSTORAGEPROXY_INDENT_LOCALSTORAGE",t.prototype._WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE="_WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE",t.prototype=new Proxy(t.prototype,{deleteProperty:function(){return!1}}),new Proxy(n,{get:function(r,t){return"crypto"===t?!r.prototype.encryption&&!Storage.prototype[n.prototype._GETITEM]&&function(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];2==e.length&&u(e[0])&&u(e[1])&&(e.forEach(function(t,e){r.prototype[e?"decryption":"encryption"]=new Proxy(t,{apply:function(t,e,o){return g(e)===n.prototype&&Reflect.apply(t,e,o)}})}),Object.freeze(r.prototype))}:Reflect.get(r,t)},construct:function(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];return e[1].length?(Storage.prototype[n.prototype._GETITEM]||function(r){function n(t){return t.split(":")[0]===r._WEBSTORAGEPROXY_NAMESPACE||t.split(":")[0]===r._WEBSTORAGEPROXY_INDENT_STORAGE}localStorage.setItem(r._WEBSTORAGEPROXY_INDENT_STORAGE,r._WEBSTORAGEPROXY_INDENT_LOCALSTORAGE),sessionStorage.setItem(r._WEBSTORAGEPROXY_INDENT_STORAGE,r._WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE),Storage.prototype[r._CLEAR]=Storage.prototype.clear,Storage.prototype[r._GETITEM]=Storage.prototype.getItem,Storage.prototype[r._SETITEM]=Storage.prototype.setItem,Storage.prototype[r._REMOVEITEM]=Storage.prototype.removeItem,Storage.prototype.clear=function(){function t(t){for(;t<e.length;)n(e.key(t))?t++:e[r._REMOVEITEM](e.key(t))}var e=this;t(0),t(0)},Storage.prototype.getItem=function(t){return!n(t)&&this[r._GETITEM](t)},Storage.prototype.setItem=function(t,e){if(!n(t)){var o=this[r._GETITEM](t);if(o!==e)return this[r._SETITEM](t,e),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/sessionStorage/i)&&f.call(this,"sessionstoragechange",this,t,e,o),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/localStorage/i)&&f.call(this,"localstoragechange",this,t,e,o),!0}return!1},Storage.prototype.removeItem=function(t){if(!n(t)){var e=this[r._GETITEM](t);if(null!==e)return this[r._REMOVEITEM](t),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/sessionStorage/i)&&f.call(this,"sessionstoragechange",this,t,null,e),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/localStorage/i)&&f.call(this,"localstoragechange",this,t,null,e),!0}return!1}}(n.prototype),Reflect.construct.apply(Reflect,e)):new ReferenceError("the length of arguments in WebStorageProxy can not be 0")}})});
