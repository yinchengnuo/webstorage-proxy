!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).WebStorageProxy=e()}(this,function(){"use strict";function r(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function i(t,e,o,r,n){window.dispatchEvent(new StorageEvent(t,{key:o,newValue:r,oldValue:n,storageArea:e,url:window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]}))}var E=function(){return{length:0}},a=function(t){return{0:t,length:1}},c=function(t,e){for(var o=arguments.length,r=new Array(2<o?o-2:0),n=2;n<o;n++)r[n-2]=arguments[n];for(var i=0;i<t.length;i++){var E;(E=t[i]).call.apply(E,[e].concat(r))}},s=function(t){return"beforeGet"===t||"geted"===t||"beforeSet"===t||"proxySeted"===t||"storageSeted"===t||"storageChanged"===t},l=function(t){return new Proxy(t,{set:function(t,e,o){if(e==t.length&&"function"==typeof o)return Reflect.set(t,e,o),t.length=t.length+=1,!0},deleteProperty:function(){return!1}})},f=function(t){t.beforeCreate=function(){},t.created=function(){},t.beforeGet=l(E()),t.geted=l(E()),t.beforeSet=l(E()),t.proxySeted=l(E()),t.storageSeted=l(E()),t.storageChanged=l(E()),t.beforeDestroy=function(){},t.destroyed=function(){}},S=function(t,e){if("string"==typeof e)t._NAMESPACE=e;else if("function"==typeof e){for(var o=[],r=new RegExp("".concat(t._WEBSTORAGEPROXY_NAMESPACE,":")),n=0;n<window[t._TYPE].length;n++)window[t._TYPE].key(n).match(r)&&o.push(window[t._TYPE].key(n).replace(r,""));t._NAMESPACE="string"==typeof e(o)?e(o):null,r=o=null}else t._NAMESPACE=null},u=function(t){return"string"==typeof t},p=function(t){return"[object Function]"===Object.prototype.toString.call(t)},h=function(t){return"[object Object]"===Object.prototype.toString.call(t)},T=function(t){return"[object Array]"===Object.prototype.toString.call(t)},_=function(t){return Object.getPrototypeOf(t)};function y(){var i=this;this.state=function r(n){return Object.keys(n).forEach(function(t){(T(n[t])||h(n[t]))&&(n[t]=r(n[t]))}),new Proxy(n,{get:function(t,e){return s(e&&_(n)===i)?i[e]:(c(i.beforeGet,t,t,e),Promise.resolve().then(function(){c(i.geted,t,t,e)}),t[e])},set:function(t,e,o){p(o)&&s(e)&&_(n)===i?i[e][i[e].length]=o:t[e]!==o&&(c(i.beforeSet,t,t,e,o),T(o)||h(o)?t[e]=r(o):t[e]=o,c(i.proxySeted,t,t,e,o),i.encryption("abcd"),console.log("更新storage",t,e,o),function(t,e){this._NAMESPACE||window[this._TYPE][this._SETITEM]("".concat(this._WEBSTORAGEPROXY,":").concat(t),e),console.log(this._NAMESPACE,t)}.call(i,e,o))},deleteProperty:function(){}})}(this.state)}var t,n=function(){function n(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),function(t){1==t.length?u(t[0])?(this._TYPE=t[0],this._NAMESPACE=null,f(this)):h(t[0])&&(this._TYPE=t[0].type,S(this,t[0].nameSpace),p(t[0].beforeCreate)&&(this.beforeCreate=t[0].beforeCreate),p(t[0].created)&&(this.created=t[0].created),p(t[0].beforeGet)?this.beforeGet=l(a(t[0].beforeGet)):l(E()),p(t[0].geted)?this.geted=l(a(t[0].geted)):l(E()),p(t[0].beforeSet)?this.beforeSet=l(a(t[0].beforeSet)):l(E()),p(t[0].proxySeted)?this.proxySeted=l(a(t[0].proxySeted)):l(E()),p(t[0].storageSeted)?this.storageSeted=l(a(t[0].storageSeted)):l(E()),p(t[0].storageChanged)?this.storageChanged=l(a(t[0].storageChanged)):l(E()),p(t[0].beforeDestroy)&&(this.beforeDestroy=t[0].beforeDestroy),p(t[0].destroyed)&&(this.destroyed=t[0].destroyed)):(this._TYPE=t[0],S(this,t[2]),f(this))}.call(r=this,e),r.beforeCreate.call(window),r.state=Object.create(r),function(){if(this._NAMESPACE){var t=window[this._TYPE][this._GETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE));t?Object.assign(this.state,JSON.parse(t)):window[this._TYPE][this._SETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE),"")}else{for(var e=window[this._TYPE],o=new RegExp("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":")),r=0;r<e.length;r++)if(!e.key(r).match(o))try{this.state[e.key(r)]=JSON.parse(e[this._GETITEM](e.key(r)))}catch(t){this.state[e.key(r)]=e[this._GETITEM](e.key(r))}o=e=null}}.call(r),y.call(r),Promise.resolve().then(function(){r.created()}),r.state;var r}return function(t,e,o){e&&r(t.prototype,e),o&&r(t,o)}(n,[{key:"all",value:function(){return function(){return JSON.parse(JSON.stringify(this.state))}.call(this)}},{key:"use",value:function(){}},{key:"del",value:function(){}},{key:"has",value:function(){}},{key:"clear",value:function(){}}]),n}();return(t=n).prototype._CLEAR=Symbol("clear"),t.prototype._GETITEM=Symbol("getItem"),t.prototype._SETITEM=Symbol("setItem"),t.prototype._REMOVEITEM=Symbol("removeItem"),t.prototype._WEBSTORAGEPROXY_NAMESPACE="_WEBSTORAGEPROXY_NAMESPACE",t.prototype._WEBSTORAGEPROXY_INDENT_STORAGE="_WEBSTORAGEPROXY_INDENT_STORAGE",t.prototype._WEBSTORAGEPROXY_INDENT_LOCALSTORAGE="_WEBSTORAGEPROXY_INDENT_LOCALSTORAGE",t.prototype._WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE="_WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE",new Proxy(n,{get:function(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];return"encryption"===e[1]||"decryption"===e[1]?!e[0].prototype[e[1]]&&!Storage.prototype[n.prototype._GETITEM]&&function(t){e[0].prototype[e[1]]=new Proxy(t,{apply:function(t,e,o){return _(e)===n.prototype&&Reflect.apply(t,e,o)}})}:Reflect.get.apply(Reflect,e)},construct:function(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];return e[1].length?(Storage.prototype[n.prototype._GETITEM]||function(r){function n(t){return t.split(":")[0]===r._WEBSTORAGEPROXY_NAMESPACE||t.split(":")[0]===r._WEBSTORAGEPROXY_INDENT_STORAGE}localStorage.setItem(r._WEBSTORAGEPROXY_INDENT_STORAGE,r._WEBSTORAGEPROXY_INDENT_LOCALSTORAGE),sessionStorage.setItem(r._WEBSTORAGEPROXY_INDENT_STORAGE,r._WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE),Storage.prototype[r._CLEAR]=Storage.prototype.clear,Storage.prototype[r._GETITEM]=Storage.prototype.getItem,Storage.prototype[r._SETITEM]=Storage.prototype.setItem,Storage.prototype[r._REMOVEITEM]=Storage.prototype.removeItem,Storage.prototype.clear=function(){function t(t){for(;t<e.length;)n(e.key(t))?t++:e[r._REMOVEITEM](e.key(t))}var e=this;t(0),t(0)},Storage.prototype.getItem=function(t){return!n(t)&&this[r._GETITEM](t)},Storage.prototype.setItem=function(t,e){if(!n(t)){var o=this[r._GETITEM](t);if(o!==e)return this[r._SETITEM](t,e),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/sessionStorage/i)||i.call(this,"sessionstoragechange",this,t,e,o),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/localStorage/i)||i.call(this,"localstoragechange",this,t,e,o),!0}return!1},Storage.prototype.removeItem=function(t){if(!n(t)){var e=this[r._GETITEM](t);if(null!==e)return this[r._REMOVEITEM](t),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/sessionStorage/i)||i.call(this,"sessionstoragechange",this,t,null,e),this[r._GETITEM](r._WEBSTORAGEPROXY_INDENT_STORAGE).match(/localStorage/i)||i.call(this,"localstoragechange",this,t,null,e),!0}return!1}}(n.prototype),Reflect.construct.apply(Reflect,e)):new ReferenceError("the length of arguments in WebStorageProxy can not be 0")}})});
