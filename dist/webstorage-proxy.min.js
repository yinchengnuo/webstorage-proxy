!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).WebStorageProxy=e()}(this,function(){"use strict";function n(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function r(t){return function(t){if(Array.isArray(t)){for(var e=0,o=new Array(t.length);e<t.length;e++)o[e]=t[e];return o}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var i=function(t,e){for(var o=arguments.length,n=new Array(2<o?o-2:0),r=2;r<o;r++)n[r-2]=arguments[r];for(var i=0;i<t.length;i++){var E;(E=t[i]).call.apply(E,[e].concat(n))}},E=function(t){return"beforeGet"===t||"geted"===t||"beforeSet"===t||"proxySeted"===t||"storageSeted"===t||"storageChanged"===t||"beforeBeyond"===t},s=function(t,e,o,n,r){window.dispatchEvent(new StorageEvent(t,{key:o,newValue:n,oldValue:r,storageArea:e,url:window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]}))},a=function(t,e){if("string"==typeof e)t._NAMESPACE=e;else if("function"==typeof e){for(var o=[],n=0;n<window[t._TYPE].length;n++)window[t._TYPE].key(n).match(new RegExp(t._WEBSTORAGEPROXY_NAMESPACE+":"))&&o.push(window[t._TYPE].key(n).replace(new RegExp(t._WEBSTORAGEPROXY_NAMESPACE+":"),""));t._NAMESPACE=e(o)}else t._NAMESPACE=null};function c(){var o=this;console.log(this.state);this.state=function n(e){var r=o,t=new Proxy(e,{get:function(t,e){return E(e)?r[e]:(i(r.beforeGet,t,t,e),Promise.resolve().then(function(){i(r.geted,t,t,e)}),t[e])},set:function(t,e,o){"function"==typeof o&&E(e)?r[e][r[e].length]=o:t[e]!==o&&(i(r.beforeSet,t,t,e,o),"[object Object]"===Object.prototype.toString.call(o)||"[object Array]"===Object.prototype.toString.call(o)?t[e]=n(o):t[e]=o,i(r.proxySeted,t,t,e,o),console.log("更新storage",t,e,o),function(t,e){this._NAMESPACE||window[this._TYPE][this._SETITEM]("".concat(this._WEBSTORAGEPROXY,":").concat(t),e),console.log(this._NAMESPACE,t)}.call(r,e,o))}});return Object.keys(e).forEach(function(t){"[object Object]"!==Object.prototype.toString.call(e[t])&&"[object Array]"!==Object.prototype.toString.call(e[t])||(e[t]=n(e[t]))}),t}(this.state)}var f=function(t){return new Proxy(t,{set:function(t,e,o){if(e==t.length&&"function"==typeof o)return t[e]=o,t.length=t.length+=1,!0},deleteProperty:function(){}})},h=function(){return{length:0}},l=function(t){return{0:t,length:1}},S=function(){this.beforeCreate=function(){},this.created=function(){},this.beforeGet=f(h()),this.geted=f(h()),this.beforeSet=f(h()),this.proxySeted=f(h()),this.storageSeted=f(h()),this.storageChanged=f(h()),this.beforeBeyond=f(h()),this.beforeDestroy=function(){},this.destroyed=function(){},this.encryption=function(){},this.decryption=function(){}};var t,e=function(){function r(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r),function(t){if(!t.length)throw new ReferenceError("the length of arguments in WebStorageProxy can not be 0");1==t.length?"string"==typeof t[0]?(this._TYPE=t[0],this._MAXSPACE=null,this._NAMESPACE=null,S.call(this)):"[object Object]"===t[0].toString()&&(this._TYPE=t[0].type,this._MAXSPACE=1024*t[0].maxSpace*1024,a(this,t[0].nameSpace),"function"==typeof t[0].beforeCreate&&(this.beforeCreate=t[0].beforeCreate),"function"==typeof t[0].created&&(this.created=t[0].created),"function"==typeof t[0].beforeGet?this.beforeGet=f(l(t[0].beforeGet)):f(h()),"function"==typeof t[0].geted?this.geted=f(l(t[0].geted)):f(h()),"function"==typeof t[0].beforeSet?this.beforeSet=f(l(t[0].beforeSet)):f(h()),"function"==typeof t[0].proxySeted?this.proxySeted=f(l(t[0].proxySeted)):f(h()),"function"==typeof t[0].storageSeted?this.storageSeted=f(l(t[0].storageSeted)):f(h()),"function"==typeof t[0].storageChanged?this.storageChanged=f(l(t[0].storageChanged)):f(h()),"function"==typeof t[0].beforeBeyond?this.beforeBeyond=f(l(t[0].beforeBeyond)):f(h()),"function"==typeof t[0].beforeDestroy&&(this.beforeDestroy=t[0].beforeDestroy),"function"==typeof t[0].destroyed&&(this.destroyed=t[0].destroyed),"function"==typeof t[0].encryption&&(this.encryption=t[0].encryption),"function"==typeof t[0].decryption&&(this.decryption=t[0].decryption)):(this._TYPE=t[0],this._MAXSPACE=1024*t[1]*1024,a(this,t[2]),S.call(this))}.call(n=this,e),null===sessionStorage.getItem(n._WEBSTORAGEPROXY_STROAGE_OVERRODE)&&function(n){function r(t){return t.split(":")[0]===n._WEBSTORAGEPROXY||t.split(":")[0]===n._WEBSTORAGEPROXY_NAMESPACE||t.split(":")[0]===n._WEBSTORAGEPROXY_INDENT_STORAGE||t.split(":")[0]===n._WEBSTORAGEPROXY_STROAGE_OVERRODE}localStorage.setItem(n._WEBSTORAGEPROXY_INDENT_STORAGE,n._WEBSTORAGEPROXY_INDENT_LOCALSTORAGE),sessionStorage.setItem(n._WEBSTORAGEPROXY_INDENT_STORAGE,n._WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE),Storage.prototype[n._CLEAR]=Storage.prototype.clear,Storage.prototype[n._GETITEM]=Storage.prototype.getItem,Storage.prototype[n._SETITEM]=Storage.prototype.setItem,Storage.prototype[n._REMOVEITEM]=Storage.prototype.removeItem,Storage.prototype.clear=function(){function t(t){for(;t<e.length;)r(e.key(t))?t++:e[n._REMOVEITEM](e.key(t))}var e=this;t(0),t(0)},Storage.prototype.getItem=function(t){return!r(t)&&this[n._GETITEM](t)},Storage.prototype.setItem=function(t,e){if(!r(t)){var o=this[n._GETITEM](t);if(o!==e)return this[n._SETITEM](t,e),this[n._GETITEM](n._WEBSTORAGEPROXY_INDENT_STORAGE).match(/sessionStorage/i)||s.call(this,"sessionstoragechange",this,t,e,o),this[n._GETITEM](n._WEBSTORAGEPROXY_INDENT_STORAGE).match(/localStorage/i)||s.call(this,"localstoragechange",this,t,e,o),!0}return!1},Storage.prototype.removeItem=function(t){if(!r(t)){var e=this[n._GETITEM](t);if(null!==e)return this[n._REMOVEITEM](t),this[n._GETITEM](n._WEBSTORAGEPROXY_INDENT_STORAGE).match(/sessionStorage/i)||s.call(this,"sessionstoragechange",this,t,null,e),this[n._GETITEM](n._WEBSTORAGEPROXY_INDENT_STORAGE).match(/localStorage/i)||s.call(this,"localstoragechange",this,t,null,e),!0}return!1}}(r.prototype),n.beforeCreate.call(window),Promise.resolve().then(function(){n.created()}),n.state=Object.create(n),function(){if(this._NAMESPACE){var t=window[this._TYPE][this._GETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE));t?Object.assign(this.state,JSON.parse(t)):window[this._TYPE][this._SETITEM]("".concat(this._WEBSTORAGEPROXY_NAMESPACE,":").concat(this._NAMESPACE),"")}else for(var e=0;e<window[this._TYPE].length;e++)if(!window[this._TYPE].key(e).match("_WEBSTORAGEPROXY_NAMESPACE"))if(window[this._TYPE].key(e).split("_WEBSTORAGEPROXY:")[1])try{this.state[window[this._TYPE].key(e).split("_WEBSTORAGEPROXY:")[1]]=JSON.parse(window[this._TYPE][this._GETITEM](window[this._TYPE].key(e)))}catch(t){this.state[window[this._TYPE].key(e).split("_WEBSTORAGEPROXY:")[1]]=window[this._TYPE][this._GETITEM](window[this._TYPE].key(e))}else try{this.state[window[this._TYPE].key(e)]=JSON.parse(window[this._TYPE][this._GETITEM](window[this._TYPE].key(e)))}catch(t){this.state[window[this._TYPE].key(e)]=window[this._TYPE][this._GETITEM](window[this._TYPE].key(e))}}.call(n),c.call(n),n.state;var n}return function(t,e,o){e&&n(t.prototype,e),o&&n(t,o)}(r,[{key:"all",value:function(){return function(){return JSON.parse(JSON.stringify(this.state))}.call(this)}},{key:"use",value:function(){}},{key:"del",value:function(){}},{key:"has",value:function(){}},{key:"clear",value:function(){}}]),r}();return(t=e).prototype._CLEAR=Symbol("clear"),t.prototype._GETITEM=Symbol("getItem"),t.prototype._SETITEM=Symbol("setItem"),t.prototype._REMOVEITEM=Symbol("removeItem"),t.prototype._WEBSTORAGEPROXY_NAMESPACE="_WEBSTORAGEPROXY_NAMESPACE",t.prototype._WEBSTORAGEPROXY_INDENT_STORAGE="_WEBSTORAGEPROXY_INDENT_STORAGE",t.prototype._WEBSTORAGEPROXY_INDENT_LOCALSTORAGE="_WEBSTORAGEPROXY_INDENT_LOCALSTORAGE",t.prototype._WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE="_WEBSTORAGEPROXY_INDENT_SESSIONSTORAGE",new Proxy(e,{get:function(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];return"encryption"===e[1]||"decryption"===e[1]?function(t){e[0].prototype[e[1]]=new Proxy(t,{apply:function(t,e,o){return!!e._TYPE&&Reflect.apply.apply(Reflect,r(o))}})}:Reflect.get.apply(Reflect,e)}})});
